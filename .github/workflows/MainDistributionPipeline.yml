#
# This workflow calls the main distribution pipeline from DuckDB to build, test and (optionally) release the extension
#
name: Main Extension Distribution Pipeline
on:
  push:
    branches: [main, next]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
    tags:
      - 'v*'
  pull_request:
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.head_ref || '' }}-${{ github.base_ref || '' }}-${{ github.ref != 'refs/heads/main' && github.sha || '' }}
  cancel-in-progress: true

jobs:
  ci-config:
    runs-on: ubuntu-latest
    outputs:
      reduced_ci_mode: ${{ steps.config.outputs.reduced_ci_mode }}
      should_run_code: ${{ steps.config.outputs.should_run_code }}
      cache_base_branch: ${{ steps.config.outputs.cache_base_branch }}
    steps:
      - uses: actions/checkout@v6
        with:
          sparse-checkout: .

      - uses: dorny/paths-filter@v3
        id: filter
        if: github.event_name != 'push' || !startsWith(github.ref, 'refs/tags/')
        with:
          filters: |
            code:
              - 'src/**'
              - 'test/tests/**'
              - 'CMakeLists.txt'
              - 'extension_config.cmake'
              - 'Makefile'
              - 'pyproject.toml'
              - 'uv.lock'

      - id: config
        run: |
          # Tags always run full CI
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            echo "should_run_code=true" >> $GITHUB_OUTPUT
            echo "reduced_ci_mode=disabled" >> $GITHUB_OUTPUT
            # Tags come from main branch (stable releases)
            echo "cache_base_branch=main" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "should_run_code=${{ steps.filter.outputs.code }}" >> $GITHUB_OUTPUT
            echo "reduced_ci_mode=enabled" >> $GITHUB_OUTPUT
            # For PRs, restore from the target branch (main or next)
            echo "cache_base_branch=${{ github.base_ref }}" >> $GITHUB_OUTPUT
          else
            echo "should_run_code=${{ steps.filter.outputs.code }}" >> $GITHUB_OUTPUT
            echo "reduced_ci_mode=disabled" >> $GITHUB_OUTPUT
            # For pushes to main/next, restore from itself
            echo "cache_base_branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

  run-tests:
    name: Run Tests
    needs: ci-config
    if: needs.ci-config.outputs.should_run_code == 'true'
    runs-on: ubuntu-latest
    env:
      GEN: ninja

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: 'true'

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Cache APT Packages
        uses: awalsh128/cache-apt-pkgs-action@v1.6.0
        with:
          packages: build-essential cmake ninja-build ccache git linux-libc-dev libssl-dev libcurl4-openssl-dev nlohmann-json3-dev

      - name: Cache ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ccache-${{ github.job }}-${{ runner.os }}-${{ github.ref_name }}
          restore-keys: |
            ccache-${{ github.job }}-${{ runner.os }}-${{ needs.ci-config.outputs.cache_base_branch }}
          max-size: "2G"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run tests
        run: |
          make -j16 test-all
        env:
          CMAKE_CXX_COMPILER_LAUNCHER: ccache
          CMAKE_C_COMPILER_LAUNCHER: ccache
          NINJA_STATUS: '[%f/%t %es] '

  duckdb-stable-build:
    name: Build extension binaries
    uses: duckdb/extension-ci-tools/.github/workflows/_extension_distribution.yml@main
    needs: [ci-config, run-tests]
    if: needs.ci-config.outputs.should_run_code == 'true'
    with:
      duckdb_version: v1.4.4
      ci_tools_version: v1.4.4
      extension_name: duck_lineage
      exclude_archs: "wasm_mvp;wasm_eh;wasm_threads;windows_amd64_mingw;"
      vcpkg_commit: 84bab45d415d22042bd0b9081aea57f362da3f35
      skip_tests: true
      reduced_ci_mode: ${{ needs.ci-config.outputs.reduced_ci_mode }}

  code-quality-check:
    name: Code Quality Check
    needs: ci-config
    if: needs.ci-config.outputs.should_run_code == 'true' && github.event.pull_request.draft != true
    uses: ./.github/workflows/_extension_code_quality.yml
    with:
      duckdb_version: v1.4.4
      ci_tools_version: v1.4.4
      extension_name: duck_lineage
      format_checks: 'format;tidy'
